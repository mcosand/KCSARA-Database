var DatabaseAccountModel=function(e){this.merge=function(e){$.extend(this,e),this.lastActive=moment(this.lastActive),this.lastPassword=moment(this.lastPassword),this.lastLocked=this.lastLocked?moment(this.lastLocked):null},this.merge(e),this.groups=[],this.groups.loaded=!1,this.linkedMember={},this.linkedMember.loaded=!1};angular.module("sarDatabase").directive("validatePasswordCharacters",function(){var e=[/\d+/,/[a-z]+/,/[A-Z]+/,/\W+/,/^\S+$/];return{require:"ngModel",link:function(o,t,n,r){r.$validators.passwordCharacters=function(o){if(!o)return!0;var t=!0;return angular.forEach(e,function(e){t=t&&e.test(o)}),t}}}}),angular.module("sarDatabase").directive("serverError",function(){return{restrict:"A",require:"?ngModel",link:function(e,o,t,n){return o.on("change keyup",function(){return e.$apply(function(){return n.$setValidity("server",!0)})})}}}),angular.module("sarDatabase").directive("statusGlyph",function(){return{restrict:"E",template:"<i ng-class=\"{'text-success': test, 'fa-check': test, 'fa-exclamation': !test, 'text-danger': !test}\" class=\"fa\"></i>",scope:{test:"="}}}),angular.module("sarDatabase").service("AccountService",["$http","$q",function(e,o){self=this,$.extend(this,{accounts:{},groups:{},initAccount:function(e){var o;return e.name&&(o=new DatabaseAccountModel(e),self.accounts[e.name]=o),o},loadGroups:function(t){var n=self.accounts[t],r=o.defer();return n.groups.loaded?(r.resolve(n.groups),r):(n.groups.length=0,n.groups.loading=!0,void e({method:"GET",url:window.appRoot+"api/account/rolesforuser/"+t}).success(function(e){$.each(e,function(e,o){self.groups[o]||(self.groups[o]={name:o,groups:[],canEdit:self.rolesIManage.indexOf(o)>=0},self.groups[o].groups.loaded=!1,n.groups.push($.extend({collapsed:!0,remove:!1},self.groups[o])))}),delete n.groups.loading,n.groups.loaded=!0,r.resolve(e)}).error(function(e){r.reject(e)}))},loadMoreGroups:function(t){var n=self.groups[t.name],r=o.defer();return n.groups.loaded?(r.resolve(),r.promise):(e({method:"GET",url:window.appRoot+"api/account/rolesforrole/"+t.name}).success(function(e){$.each(e,function(e,o){self.groups[o]||(self.groups[o]={name:o,groups:[]},self.groups[o].groups.loaded=!1),n.groups.push($.extend({collapsed:!0,remove:!1},self.groups[o]))}),n.groups.loaded=!0}),r.promise)},loadLinkedMember:function(t){var n=self.accounts[t],r=o.defer();return n.linkedMember.loaded?(r.resolve(n.linkedMember),r.promise):(n.linkedMember.loading=!0,e({method:"GET",url:window.appRoot+"api/members/byusername/"+t}).success(function(e){1==e.length&&(n.linkedMember.id=e[0].Id,n.linkedMember.name=e[0].Name,n.linkedMember.units=e[0].Units,n.linkedMember.dem=e[0].DEM),delete n.linkedMember.loading,n.linkedMember.loaded=!0,r.resolve(e)}).error(function(e){r.reject(e)}),r.promise)},getMemberAccount:function(t){var n=o.defer();return e({method:"GET",url:window.appRoot+"api/members/accountfor/"+t}).success(function(e){n.resolve(e)}).error(function(e){n.reject(e)}),n.promise},save:function(t){var n=o.defer();return t.linkedMember.loaded&&delete t.linkedMember.loaded,e({method:"PUT",url:window.appRoot+"api/account",data:t}).success(function(e){n.resolve(e)}).error(function(e){n.reject(e)}),n.promise},setPassword:function(t){if("set"==t.type)return self.save($.extend({},t.account,{password:t.password}));var n=o.defer();return e({method:"POST",url:window.appRoot+"api/account/resetpassword/"+t.account.name}).success(function(e){n.resolve()}).error(function(e){n.reject(e)}),n.promise}})}]),define(["moment","sarDatabase","ng-file-upload"],function(e){var o={SignedOut:"Signed Out"};angular.module("sarDatabase").service("EventsService",["$http","$q","Upload",function(t,n,r){function s(e,o,r){for(var s=n.defer(),i=0;i<a.length;i++)a[i].list===e&&(console.log("cancelling previous request to "+a[i].url),a[i].cancel.reject("replaced"),a.splice(i,1));var u=n.defer();e.length=0,e.loading=!0;var c={list:e,url:o,cancel:u};return a.push(c),t({method:"GET",url:o,timeout:u.promise}).success(function(o){r?r(o):e.push.apply(e,o),delete e.loading,e.loaded=!0,a.splice(a.indexOf(c),1),s.resolve(o)}).error(function(e){a.splice(a.indexOf(c),1),s.reject(e)}),s.promise}self=this;var a=[];$.extend(this,{list:function(o,t,n){return s(o,window.appRoot+"api/"+t+"/list/"+(n||""),function(t){$.each(t.events,function(t,n){n.date=e(n.date),o.unshift(n)}),o.people=t.people,o.miles=t.miles,o.hours=t.hours})},years:function(e,o){return s(e,window.appRoot+"api/"+o+"/years")},save:function(o,r){var s=n.defer();return t({method:o.id?"PUT":"POST",url:window.appRoot+"api/"+r,data:o}).success(function(o){o.start=e(o.start),o.stop&&(o.stop=e(o.stop)),s.resolve(o)}).error(function(e){s.reject(e)}),s.promise},documents:function(e,o,t){return s(e,window.appRoot+"api/documents/"+t,function(o){$.each(o,function(o,t){t.thumbUrl=window.appRoot+("image"==t.mime.substring(0,5)?"documents/"+t.id+"/thumbnail":"images/mime/"+t.mime.replace("/","_").replace("+","-")+".png"),t.url=window.appRoot+"documents/"+t.id,t.size=Math.round(t.size/1024*10)/10+"KB",e.push(t)})})},logs:function(o,t,n){return s(o,window.appRoot+"api/"+t+"/"+n+"/logs",function(t){$.each(t,function(t,r){r.eventId=n,r.time=e(r.time);var s=e(r.time);s.startOf("day"),(0==o.length||o[o.length-1].date.format()!=s.format())&&o.push({date:s,logs:[]}),o[o.length-1].logs.push(r)})})},saveLog:function(o,r){var s=n.defer();return t({method:o.id?"PUT":"POST",url:window.appRoot+"api/"+r+"/"+o.eventId+"/log",data:o}).success(function(o){o.time=e(o.time),s.resolve(o)}).error(function(e,o){s.reject(403==o?"login":e)}),s.promise},deleteLog:function(e,o,r){var s=n.defer();return t({method:"DELETE",url:window.appRoot+"api/"+r+"/"+e+"/log/"+o}).success(function(e){s.resolve(e)}).error(function(e,o){s.reject(403==o?"login":e)}),s.promise},saveDocument:function(e){var o=n.defer();return r.upload({url:window.appRoot+"api/documents/"+e.eventId,data:e}).then(function(e){console.log("Success "+e.config.data.file.name+"uploaded. Response: "+e.data),o.resolve(e.data)},function(e){console.log("Error status: "+e.status),o.reject(e)},function(e){var o=parseInt(100*e.loaded/e.total);console.log("progress: "+o+"% "+e.config.data.file.name)}),o.promise},deleteDocument:function(e){var o=n.defer();return t({method:"DELETE",url:window.appRoot+"api/documents/"+e}).success(function(e){o.resolve(e)}).error(function(e,t){o.reject(403==t?"login":e)}),o.promise},roster:function(e,t,n){return s(e,window.appRoot+"api/"+t+"/"+n+"/roster",function(t){$.each(t.responders,function(t,n){n.statusText=o[n.status]||n.status,e.push(n)}),e.responderCount=t.responderCount})},participantTimeline:function(o,t,n,r){return s(o,window.appRoot+"api/"+t+"/"+n+"/participant/"+r+"/timeline",function(t){$.each(t,function(t,n){n.time=n.time?e(n.time):null,o.push(n)})})}})}])});