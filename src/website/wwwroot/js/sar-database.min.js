function scrollToTop(e){return $("html").scrollTop()?void $("html").animate({scrollTop:0},{duration:200,complete:e}):$("body").scrollTop()?void $("body").animate({scrollTop:0},{duration:200,complete:e}):void e()}function CreateEditorController(e,t,n,o){angular.module("sarDatabase").controller(e,["$uibModalInstance","dialog","model","EventsService",function(e,r,i,a){var s=this;$.extend(s,{dismiss:function(t){e.dismiss(t)},submit:function(){s.createForm.$valid&&(s.isSaving=!0,s.isWorking=!0,s.errors={},t(s,a).then(function(){delete s.isSaving,delete s.isWorking,e.close(s.model)},function(e){angular.forEach(e.errors,function(e,t){void 0!==s.createForm[t]&&s.createForm[t].$setValidity("server",!1),s.errors[t]=e}),delete s.isSaving,delete s.isWorking}))},checkDelete:function(t){confirm("Delete "+t+"?")&&(s.isDeleting=!0,s.isWorking=!0,n(s.model.id,a,s).then(function(){delete s.isDeleting,delete s.isWorking,e.close(s.model)},function(e){alert("Error: "+e),delete s.isDeleting,delete s.isWorking}))},dialog:r,model:i},(o||function(){})(s))}])}angular.module("sarDatabase").service("ApiLoader",["$http","$q",function(e,t){var n=this,o=[];$.extend(this,{getInto:function(n,r,i,a){for(var s=t.defer(),l=0;l<o.length;l++)o[l].target===n&&(console.log("cancelling previous request to "+o[l].url),o[l].cancel.reject("replaced"),o.splice(l,1));var u=t.defer();n.loading=!0;var c={target:n,url:r,cancel:u};return o.push(c),e({method:a&&a.method?a.method:"GET",url:r,timeout:u.promise,data:a&&a.data?a.data:null}).success(function(e){i?i(e):$.extend(n,e),delete n.loading,n.loaded=!0,o.splice(o.indexOf(c),1),s.resolve(e)}).error(function(e){o.splice(o.indexOf(c),1),s.reject(e)}),s.promise},getIntoList:function(e,t,o){return e.length=0,n.getInto(e,t,o||function(t){e.push.apply(e,t)})}})}]),angular.module("sarDatabase").service("EventsService",["ApiLoader","$http","$q","Upload",function(e,t,n,o){var r={SignedOut:"Signed Out"};$.extend(this,{list:function(t,n,o){return e.getIntoList(t,window.appRoot+"api/"+n+"/list/"+(o||""),function(e){$.each(e.events,function(e,n){n.date=moment(n.date),t.unshift(n)}),t.people=e.people,t.miles=e.miles,t.hours=e.hours})},years:function(t,n){return e.getIntoList(t,window.appRoot+"api/"+n+"/years")},save:function(e,o){var r=n.defer();return t({method:e.id?"PUT":"POST",url:window.appRoot+"api/"+o,data:e}).success(function(e){e.start=moment(e.start),e.stop&&(e.stop=moment(e.stop)),r.resolve(e)}).error(function(e){r.reject(e)}),r.promise},documents:function(t,n,o){return e.getIntoList(t,window.appRoot+"api/documents/"+o,function(e){$.each(e,function(e,n){n.thumbUrl=window.appRoot+("image"==n.mime.substring(0,5)?"documents/"+n.id+"/thumbnail":"images/mime/"+n.mime.replace("/","_").replace("+","-")+".png"),n.url=window.appRoot+"documents/"+n.id,n.size=Math.round(n.size/1024*10)/10+"KB",t.push(n)})})},logs:function(t,n,o){return e.getIntoList(t,window.appRoot+"api/"+n+"/"+o+"/logs",function(e){$.each(e,function(e,n){n.eventId=o,n.time=moment(n.time);var r=moment(n.time);r.startOf("day"),(0==t.length||t[t.length-1].date.format()!=r.format())&&t.push({date:r,logs:[]}),t[t.length-1].logs.push(n)})})},saveLog:function(e,o){var r=n.defer();return t({method:e.id?"PUT":"POST",url:window.appRoot+"api/"+o+"/"+e.eventId+"/log",data:e}).success(function(e){e.time=moment(e.time),r.resolve(e)}).error(function(e,t){r.reject(403==t?"login":e)}),r.promise},deleteLog:function(e,o,r){var i=n.defer();return t({method:"DELETE",url:window.appRoot+"api/"+r+"/"+e+"/log/"+o}).success(function(e){i.resolve(e)}).error(function(e,t){i.reject(403==t?"login":e)}),i.promise},saveDocument:function(e){var t=n.defer();return o.upload({url:window.appRoot+"api/documents/"+e.eventId,data:e}).then(function(e){console.log("Success "+e.config.data.file.name+"uploaded. Response: "+e.data),t.resolve(e.data)},function(e){console.log("Error status: "+e.status),t.reject(e)},function(e){var t=parseInt(100*e.loaded/e.total);console.log("progress: "+t+"% "+e.config.data.file.name)}),t.promise},deleteDocument:function(e){var o=n.defer();return t({method:"DELETE",url:window.appRoot+"api/documents/"+e}).success(function(e){o.resolve(e)}).error(function(e,t){o.reject(403==t?"login":e)}),o.promise},roster:function(t,n,o){return e.getIntoList(t,window.appRoot+"api/"+n+"/"+o+"/roster",function(e){$.each(e.responders,function(e,n){n.statusText=r[n.status]||n.status,t.push(n)}),t.responderCount=e.responderCount})},participantTimeline:function(t,n,o,r){return e.getIntoList(t,window.appRoot+"api/"+n+"/"+o+"/participant/"+r+"/timeline",function(e){$.each(e,function(e,n){n.time=n.time?moment(n.time):null,t.push(n)})})},participantAwards:function(t,n,o){return e.getIntoList(t,window.appRoot+"api/members/"+o+"/training/event/"+n,function(e){$.each(e,function(e,n){t.push(n)})})},stats:function(t,n){return e.getIntoList(t,window.appRoot+"api/"+n+"/stats",function(e){$.extend(t,e),delete t.length})}})}]),angular.module("sarDatabase").service("MembersService",["ApiLoader","$http","$q",function(e,t,n){$.extend(this,{memberships:function(t,n){return e.getIntoList(t,window.appRoot+"api/members/"+n+"/memberships",function(e){$.each(e,function(e,n){n.start=moment(n.start),n.stop&&(n.stop=moment(n.stop)),t.push(n)})})},medical:function(t,n,o){return e.getInto(t,window.appRoot+"api/members/"+n+"/medical",null)},addresses:function(t,n){return e.getIntoList(t,window.appRoot+"api/members/"+n+"/addresses",null)},contacts:function(t,n){return e.getIntoList(t,window.appRoot+"api/members/"+n+"/contacts",null)},events:function(t,n,o){return e.getIntoList(t,window.appRoot+"api/members/"+n+"/"+o,function(e){t.count=t.hours=t.miles=0,$.each(e,function(e,n){n.date=moment(n.date),t.unshift(n),t.count++,t.hours+=n.hours||0,t.miles+=n.miles||0})})},eventTimeline:function(t,n,o,r){return e.getIntoList(t,window.appRoot+"api/members/"+n+"/"+o+"/"+r+"/timeline",function(e){$.each(e,function(e,n){n.time=n.time?moment(n.time):null,t.unshift(n)})})},eventAwards:function(t,n,o){return e.getIntoList(t,window.appRoot+"api/members/"+n+"/training/event/"+o,function(e){$.each(e,function(e,n){t.push(n)})})},latestTraining:function(t,n){return e.getIntoList(t,window.appRoot+"api/members/"+n+"/training/latest",function(e){$.each(e,function(e,n){n.completed&&(n.completed=moment(n.completed)),n.expires&&(n.expires=moment(n.expires)),t.unshift(n)})})},requiredTraining:function(t,n){return e.getIntoList(t,window.appRoot+"api/members/"+n+"/training/required",function(e){for(var n=function(e){e.expires=e.expires?moment(e.expires):null,e.text=e.expires?e.expires.format("YYYY‑MM‑DD"):e.status,e.completed=e.completed?moment(e.completed):null},o=0;o<e.length;o++){for(var r=e[o].courses,i=0;i<r.length;i++){var a=r[i];if(n(a),a.parts&&a.parts.length)for(var s=0;s<a.parts.length;s++)n(a.parts[s])}t.push(e[o])}})}})}]),angular.module("sarDatabase").service("UnitsService",["ApiLoader","$http","$q",function(e,t,n){$.extend(this,{roster:function(t,n){return e.getIntoList(t,window.appRoot+"api/units/"+n+"/roster",function(e){$.each(e,function(e,n){n.asOf=moment(n.asOf),t.push(n)})})}})}]),angular.module("sarDatabase").factory("loginRecover",["$q","$injector",function(e,t){var n={responseError:function(n){if(403==n.status){var o=t.get("$uibModal"),r=t.get("$http"),i=e.defer(),a=o.open({templateUrl:window.appRoot+"partials/login-modal.html",controller:"LoginModalCtrl",controllerAs:"modal",size:"md",keyboard:!1,backdrop:"static"});a.result.then(function(e){i.resolve(e)},function(e){i.reject(e)});var s=i.promise;return n.config.dontRetryAfterLogin||(s=s.then(function(){return r(n.config)})),s}return e.reject(n)}};return n}]),angular.module("sarDatabase").controller("DashboardCtrl",["$scope","EventsService",function(e,t){$.extend(e,{trainingStats:{},missionStats:{}}),t.stats(e.missionStats,"missions"),t.stats(e.trainingStats,"training");var n=L.map("eventMap").fitBounds([[47.16,-122.53],[47.77,-121.22]]);L.kcsarSetupMap(n,{showLayers:!0,defaultBase:"Google Streets"})}]),angular.module("sarDatabase").controller("LoginModalCtrl",["$uibModalInstance","$q","$http",function(e,t,n){var o=this;$.extend(o,{username:"",password:"",dismiss:function(t){e.dismiss(t)},submit:function(){n({method:"POST",url:window.appRoot+"api/account/login",data:{username:o.username,password:o.password}}).success(function(t){e.close(o.model)})}})}]),angular.module("sarDatabase").controller("MainSearchCtrl",["$scope",function(e){$.extend(e,{searchOptions:{url:window.appRoot+"api/search/",searchParam:"q",itemTemplateUrl:"searchResult.html",listClass:"list-group search-results",limit:8,noFixWidth:!1,onSelect:function(e){"Member"==e.type?window.location.href=window.appRoot+"Members/"+e.summary.id:"Mission"==e.type?window.location.href=window.appRoot+"Missions/"+e.summary.id:console.log(e)}}})}]),angular.module("sarDatabase").controller("EventListCtrl",["$scope","$rootScope","$location","$uibModal","EventsService",function(e,t,n,o,r){function i(){var e=(n.path()||"").match(/\d{4}/);return e?1*e[0]:null}console.log("page loads with location: "+(n.path()||"null"));var a=function(t,o){r.list(e.list,o,t),n.path(t)};$.extend(e,{list:[],years:[],year:i(),detailedEvent:null,eventMap:null,eventTypeText:"",eventRoute:"unknown",init:function(t,n){e.eventRoute=t,e.eventTypeText=n,e.year&&a(e.year,e.eventRoute),r.years(e.years,e.eventRoute).then(function(t){!e.year&&t.length>0&&(e.year=t[0],console.log("setting year in years callback: "+(e.year||"null")))})},showInfo:function(t){e.detailedEvent=e.detailedEvent==t?null:t,e.detailedEvent&&e.detailedEvent.baseLocation&&window.setTimeout(function(){e.eventMap=L.map("eventMap",{zoomControl:!1,attributionControl:!1,dragging:!1,touchZoom:!1,scrollWheelZoom:!1,doubleClickZoom:!1,boxZoom:!1}).setView([e.detailedEvent.baseLocation.lat,e.detailedEvent.baseLocation.lng],10),L.kcsarStaticMap(e.eventMap,{showLayers:!1,defaultBase:"OpenStreetMap"})},5)},tabLink:function(t,n){return window.appRoot+e.eventRoute+"/"+n+"#/"+t},mapClick:function(e,t){alert("hi"),t.stopPropagation()},startCreate:function(){var t=n.path().split("/");t.length<1&&t.push(""),t.length<2&&t.push(e.year),t.length<3&&t.push("create"),t[2]="create",n.path(t.join("/"))},showCreateDialog:function(){scrollToTop(function(){var t={start:moment(),startText:function(e){return arguments.length&&e?(t.start=moment(e,["YYYY-MM-DD HH:mm","YYYY-MM-DD HHmm","MM/DD/YYYY HH:mm","MM/DD/YYYY HHmm"]),t.start.toJSON=function(){return t.start.format("YYYY-MM-DDTHH:mm")},t.start):arguments.length?void(t.start=null):t.start.format("YYYY-MM-DD HH:mm")},county:"king"};t.start.toJSON=function(){return t.start.format("YYYY-MM-DDTHH:mm")};var r=o.open({templateUrl:window.appRoot+"partials/events/create.html",controller:"CreateEventCtrl",controllerAs:"modal",size:"lg",resolve:{model:function(){return t},dialog:function(){return{eventType:e.eventTypeText,eventRoute:e.eventRoute}}}});r.result.then(function(t){a(t.start.year(),e.eventRoute),n.path(n.path().toUpperCase().replace("/CREATE",""))},function(e){n.path(n.path().toUpperCase().replace("/CREATE",""))})})},can:{create:!0}}),e.$watch("year",function(t,n){t!=n&&(console.log("updating list from year watcher. Newvalue:"+t),a(t,e.eventRoute))}),t.$on("$locationChangeStart",function(t,o,r){console.log("handle hash change:"+n.path()),e.year=i(),console.log(n.path().toLowerCase().indexOf("/create")),n.path().toLowerCase().indexOf("/create")>-1&&e.showCreateDialog()})}]),angular.module("sarDatabase").controller("CreateEventCtrl",["$uibModalInstance","dialog","model","EventsService",function(e,t,n,o){var r=this;r.dismiss=function(t){e.dismiss(t)},r.submit=function(){r.createForm.$valid&&(r.errors={},o.save(r.model,t.eventRoute).then(function(){e.close(r.model)},function(e){angular.forEach(e.errors,function(e,t){void 0!==r.createForm[t]&&r.createForm[t].$setValidity("server",!1),r.errors[t]=e})}))},r.dialog=t,r.model=n,r.isBasicOpen=!0,r.lastStep=!1}]),angular.module("sarDatabase").controller("EventViewCtrl",["$scope","$location","$uibModal","EventsService",function(e,t,n,o){function r(e){return(e.match(/^#\/?([^\/]+)/)||["#/info","info"])[1]}$.extend(e,{activeTab:r(t.path()),setTab:function(e){t.path(e)}}),e.$watch(function(){return location.hash},function(t){e.activeTab=r(t)})}]),angular.module("sarDatabase").controller("EventRosterCtrl",["$scope","$uibModal","EventsService",function(e,t,n){$.extend(e,{roster:[],current:null,currentDetails:null,eventRoute:"unknown",eventId:"",init:function(t,o){e.eventRoute=t,e.eventId=o,n.roster(e.roster,t,o).then(null,function(e){console.log(e),alert("error")})},setCurrent:function(t){return t&&e.current&&t.id==e.current.id?void(e.current=null):(e.current=$.extend({},t,{timeline:[],awards:[]}),n.participantTimeline(e.current.timeline,e.eventRoute,e.eventId,t.id),void(t.memberId&&n.participantAwards(e.current.awards,e.eventId,t.memberId)))},startUpdateStatus:function(e){alert("ok")},can:{create:!0}})}]),angular.module("sarDatabase").controller("EventLogCtrl",["$scope","$uibModal","EventsService",function(e,t,n){$.extend(e,{logs:[],eventRoute:"unknown",eventId:"",init:function(t,o){e.eventRoute=t,e.eventId=o,n.logs(e.logs,t,o).then(null,function(e){console.log(e),alert("error")})},dateText:function(e){return e.calendar(null,{sameDay:"[Today] dddd MM/DD/YYYY",nextDay:"[Tomorrow]",nextWeek:"dddd",lastDay:"[Yesterday] dddd MM/DD/YYYY",lastWeek:"[Last] dddd MM/DD/YYYY",sameElse:"MM/DD/YYYY dddd"})},openLog:function(o,r){o.time.toJSON=function(){return o.time.format("YYYY-MM-DDTHH:mm")},o.timeText=function(e){return arguments.length&&e?(o.time=moment(e,["YYYY-MM-DD HH:mm","YYYY-MM-DD HHmm","MM/DD/YYYY HH:mm","MM/DD/YYYY HHmm"]),o.time.toJSON=function(){return o.time.format("YYYY-MM-DDTHH:mm")},o.time):arguments.length?void(o.time=null):o.time.format("YYYY-MM-DD HH:mm")};var i=t.open({templateUrl:window.appRoot+"partials/events/edit-log.html",controller:"CreateLogCtrl",controllerAs:"modal",size:"lg",resolve:{model:function(){return o},dialog:function(){return{eventRoute:e.eventRoute,isCreate:r}}}});i.result.then(function(t){n.logs(e.logs,e.eventRoute,e.eventId)},function(e){})},startCreate:function(){var t={time:moment(),eventId:e.eventId};e.openLog(t,!0)},can:{create:!0}})}]),angular.module("sarDatabase").controller("EventDocsCtrl",["$scope","$uibModal","EventsService",function(e,t,n){$.extend(e,{documents:[],current:null,eventRoute:"unknown",eventId:"",init:function(t,o){e.eventRoute=t,e.eventId=o,n.documents(e.documents,t,o).then(null,function(e){console.log(e),alert("error")})},downloadDoc:function(e){window.open(e,"_blank","")},editDoc:function(t){e.openDoc(t,!1)},setCurrent:function(t){e.current=t==e.current?null:t},startCreate:function(){var t={eventId:e.eventId,type:"unknown"};e.openDoc(t,!0)},openDoc:function(o,r){var i=t.open({templateUrl:window.appRoot+"partials/events/edit-document.html",controller:"CreateDocCtrl",controllerAs:"modal",size:"md",resolve:{model:function(){return o},dialog:function(){return{eventRoute:e.eventRoute,isCreate:r}}}});i.result.then(function(){n.documents(e.documents,e.eventRoute,e.eventId)},function(e){})},can:{create:!0}})}]),CreateEditorController("CreateDocCtrl",function(e,t){return t.saveDocument(e.model,e.dialog.eventRoute)},function(e,t){return t.deleteDocument(e)},function(e){return{download:function(){window.open(e.model.url,"_blank","")}}}),angular.module("sarDatabase").controller("MembersDashboardCtrl",["$scope",function(e){$.extend(e,{searchOptions:{url:window.appRoot+"api/search/",searchParam:"q",itemTemplateUrl:"searchResult.html",listClass:"list-group search-results",limit:8,params:{t:"Member"},onSelect:function(e){window.location.href=window.appRoot+"Members/"+e.summary.id}}})}]),angular.module("sarDatabase").controller("MembersDetailCtrl",["$scope","$location",function(e,t){function n(e){return(e.match(/^#\/?([^\/]+)/)||["#/info","info"])[1]}$.extend(e,{activeTab:n(t.path()),init:function(t){e.memberId=t},setTab:function(e){""==t.path()&&t.replace(),t.path(e)}}),e.$watch(function(){return location.hash},function(t){e.activeTab=n(t)})}]),angular.module("sarDatabase").controller("MemberContactsCtrl",["$scope","$uibModal","MembersService",function(e,t,n){$.extend(e,{contacts:[],addresses:[],memberId:"",init:function(t){e.memberId=t,n.contacts(e.contacts,t).then(null,function(e){console.log(e),alert("error")}),n.addresses(e.addresses,t).then(null,function(e){console.log(e),alert("error")})},startAddContact:function(){alert("add contact")},startAddAddress:function(){alert("add address")}})}]),angular.module("sarDatabase").controller("MemberEventsCtrl",["$scope","$uibModal","MembersService",function(e,t,n){$.extend(e,{events:[],memberId:"",eventType:"",showUnitColumn:!0,eventTypeText:"Event",init:function(t,o,r,i){e.showUnitColumn=r,e.memberId=t,e.eventType=o,e.eventTypeText=i,n.events(e.events,t,o).then(null,function(e){console.log(e),alert("error")})},showInfo:function(t){e.detailedEvent=e.detailedEvent==t?null:t,e.detailedEvent&&!e.detailedEvent.timeline&&(e.detailedEvent.timeline=[],e.detailedEvent.awards=[],n.eventTimeline(e.detailedEvent.timeline,e.memberId,e.eventType,t.id),n.eventAwards(e.detailedEvent.awards,e.memberId,t.id))},tabLink:function(t,n){return window.appRoot+e.eventRoute+"/"+n+"#/"+t}})}]),angular.module("sarDatabase").controller("MemberInfoCtrl",["$scope","$uibModal","MembersService",function(e,t,n){$.extend(e,{memberships:[],memberId:"",isSelf:!0,viewMedical:!1,init:function(t,o){e.memberId=t,e.isSelf=o,n.memberships(e.memberships,t).then(null,function(e){console.log(e),alert("error")})},toggleMedical:function(t){return e.isSelf?(e.viewMedical=!e.viewMedical,void(e.viewMedical&&!e.medical&&(e.medical={},n.medical(e.medical,e.memberId)))):(t.preventDefault(),t.stopPropagation(),alert("This information is private."),!1)},startAddMembership:function(){alert("add membership")}})}]),angular.module("sarDatabase").controller("MemberTrainingCtrl",["$scope","$uibModal","MembersService",function(e,t,n){$.extend(e,{latest:[],required:[],memberId:"",moreTraining:!1,init:function(t){e.memberId=t,n.latestTraining(e.latest,t).then(null,function(e){console.log(e),alert("error")}),n.requiredTraining(e.required,t).then(null,function(e){console.log(e),alert("error")})},showMoreTraining:function(){e.moreTraining=!0},requiredDetails:function(e){var n=t.open({templateUrl:window.appRoot+"partials/members/required-detail.html",controller:"MemberRequiredDetailCtrl",controllerAs:"modal",size:"md",resolve:{model:function(){return e}}});n.result.then(function(e){},function(e){})}})}]),angular.module("sarDatabase").controller("MemberRequiredDetailCtrl",["$uibModalInstance","model",function(e,t){var n=this;$.extend(n,{model:t,dismiss:function(t){e.dismiss(t)}})}]),angular.module("sarDatabase").controller("UnitRosterCtrl",["$scope","UnitsService",function(e,t){$.extend(e,{roster:[],unitId:null,options:{showAll:!1},init:function(n){e.unitId=n,e.sort("member.name"),t.roster(e.roster,n).then(null,function(e){console.log(e),alert("error")})},sort:function(t){t==e.roster.sort?e.roster.sortDir=!e.roster.sortDir:(e.roster.sort=t,e.roster.sortDir=!1)},rosterFilter:function(t){return"true"===e.options.showAll||t.isActive}})}]);