var DatabaseAccountModel=function(e){this.merge=function(e){$.extend(this,e),this.lastActive=moment(this.lastActive),this.lastPassword=moment(this.lastPassword),this.lastLocked=this.lastLocked?moment(this.lastLocked):null},this.merge(e),this.groups=[],this.groups.loaded=!1,this.linkedMember={},this.linkedMember.loaded=!1};angular.module("sarDatabase").directive("validatePasswordCharacters",function(){var e=[/\d+/,/[a-z]+/,/[A-Z]+/,/\W+/,/^\S+$/];return{require:"ngModel",link:function(o,t,r,n){n.$validators.passwordCharacters=function(o){if(!o)return!0;var t=!0;return angular.forEach(e,function(e){t=t&&e.test(o)}),t}}}}),angular.module("sarDatabase").directive("serverError",function(){return{restrict:"A",require:"?ngModel",link:function(e,o,t,r){return o.on("change keyup",function(){return e.$apply(function(){return r.$setValidity("server",!0)})})}}}),angular.module("sarDatabase").directive("statusGlyph",function(){return{restrict:"E",template:"<i ng-class=\"{'text-success': test, 'fa-check': test, 'fa-exclamation': !test, 'text-danger': !test}\" class=\"fa\"></i>",scope:{test:"="}}}),angular.module("sarDatabase").service("AccountService",["$http","$q",function(e,o){self=this,$.extend(this,{accounts:{},groups:{},initAccount:function(e){var o;return e.name&&(o=new DatabaseAccountModel(e),self.accounts[e.name]=o),o},loadGroups:function(t){var r=self.accounts[t],n=o.defer();return r.groups.loaded?(n.resolve(r.groups),n):(r.groups.length=0,r.groups.loading=!0,void e({method:"GET",url:window.appRoot+"api/account/rolesforuser/"+t}).success(function(e){$.each(e,function(e,o){self.groups[o]||(self.groups[o]={name:o,groups:[],canEdit:self.rolesIManage.indexOf(o)>=0},self.groups[o].groups.loaded=!1,r.groups.push($.extend({collapsed:!0,remove:!1},self.groups[o])))}),delete r.groups.loading,r.groups.loaded=!0,n.resolve(e)}).error(function(e){n.reject(e)}))},loadMoreGroups:function(t){var r=self.groups[t.name],n=o.defer();return r.groups.loaded?(n.resolve(),n.promise):(e({method:"GET",url:window.appRoot+"api/account/rolesforrole/"+t.name}).success(function(e){$.each(e,function(e,o){self.groups[o]||(self.groups[o]={name:o,groups:[]},self.groups[o].groups.loaded=!1),r.groups.push($.extend({collapsed:!0,remove:!1},self.groups[o]))}),r.groups.loaded=!0}),n.promise)},loadLinkedMember:function(t){var r=self.accounts[t],n=o.defer();return r.linkedMember.loaded?(n.resolve(r.linkedMember),n.promise):(r.linkedMember.loading=!0,e({method:"GET",url:window.appRoot+"api/members/byusername/"+t}).success(function(e){1==e.length&&(r.linkedMember.id=e[0].Id,r.linkedMember.name=e[0].Name,r.linkedMember.units=e[0].Units,r.linkedMember.dem=e[0].DEM),delete r.linkedMember.loading,r.linkedMember.loaded=!0,n.resolve(e)}).error(function(e){n.reject(e)}),n.promise)},getMemberAccount:function(t){var r=o.defer();return e({method:"GET",url:window.appRoot+"api/members/accountfor/"+t}).success(function(e){r.resolve(e)}).error(function(e){r.reject(e)}),r.promise},save:function(t){var r=o.defer();return t.linkedMember.loaded&&delete t.linkedMember.loaded,e({method:"PUT",url:window.appRoot+"api/account",data:t}).success(function(e){r.resolve(e)}).error(function(e){r.reject(e)}),r.promise},setPassword:function(t){if("set"==t.type)return self.save($.extend({},t.account,{password:t.password}));var r=o.defer();return e({method:"POST",url:window.appRoot+"api/account/resetpassword/"+t.account.name}).success(function(e){r.resolve()}).error(function(e){r.reject(e)}),r.promise}})}]),angular.module("sarDatabase").service("EventsService",["$http","$q",function(e,o){self=this,$.extend(this,{list:function(t,r,n){var s=o.defer();t.length=0,t.loading=!0,e({method:"GET",url:window.appRoot+"api/"+r+"/list/"+(n||"")}).success(function(e){$.each(e.events,function(e,o){o.date=moment(o.date),t.unshift(o)}),t.people=e.people,t.miles=e.miles,t.hours=e.hours,delete t.loading,t.loaded=!0,s.resolve(e)}).error(function(e){s.reject(e)})},years:function(t,r){var n=o.defer();return e({method:"GET",url:window.appRoot+"api/"+r+"/years"}).success(function(e){t.length=0,t.push.apply(t,e),n.resolve(e)}).error(function(e){n.reject(e)}),n.promise},save:function(t,r){var n=o.defer();return e({method:t.id?"PUT":"POST",url:window.appRoot+"api/"+r,data:t}).success(function(e){e.start=moment(e.start),e.stop&&(e.stop=moment(e.stop)),n.resolve(e)}).error(function(e){n.reject(e)}),n.promise},documents:function(t,r,n){var s=o.defer();return t.length=0,t.loading=!0,e({method:"GET",url:window.appRoot+"api/documents/"+n}).success(function(e){$.each(e,function(e,o){o.thumbUrl=window.appRoot+("image"==o.mime.substring(0,5)?"documents/"+o.id+"/thumbnail":"images/mime/"+o.mime.replace("/","_")+".png"),o.url=window.appRoot+"documents/"+o.id,o.size=Math.round(o.size/1024*10)/10+"KB",t.push(o)}),delete t.loading,t.loaded=!0,s.resolve(e)}).error(function(e){s.reject(e)}),s.promise},logs:function(t,r,n){var s=o.defer();return t.length=0,t.loading=!0,e({method:"GET",url:window.appRoot+"api/"+r+"/"+n+"/logs"}).success(function(e){$.each(e,function(e,o){o.eventId=n,o.time=moment(o.time);var r=moment(o.time);r.startOf("day"),(0==t.length||t[t.length-1].date.format()!=r.format())&&t.push({date:r,logs:[]}),t[t.length-1].logs.push(o)}),delete t.loading,t.loaded=!0,s.resolve(e)}).error(function(e,o){s.reject(403==o?"login":e)}),s.promise},saveLog:function(t,r){var n=o.defer();return e({method:t.id?"PUT":"POST",url:window.appRoot+"api/"+r+"/"+t.eventId+"/log",data:t}).success(function(e){e.time=moment(e.time),n.resolve(e)}).error(function(e,o){n.reject(403==o?"login":e)}),n.promise}})}]);