var DatabaseAccountModel=function(e){this.merge=function(e){$.extend(this,e),this.lastActive=moment(this.lastActive),this.lastPassword=moment(this.lastPassword),this.lastLocked=this.lastLocked?moment(this.lastLocked):null},this.merge(e),this.groups=[],this.groups.loaded=!1,this.linkedMember={},this.linkedMember.loaded=!1};angular.module("sarDatabase").directive("validatePasswordCharacters",function(){var e=[/\d+/,/[a-z]+/,/[A-Z]+/,/\W+/,/^\S+$/];return{require:"ngModel",link:function(r,o,t,s){s.$validators.passwordCharacters=function(r){if(!r)return!0;var o=!0;return angular.forEach(e,function(e){o=o&&e.test(r)}),o}}}}),angular.module("sarDatabase").directive("serverError",function(){return{restrict:"A",require:"?ngModel",link:function(e,r,o,t){return r.on("change keyup",function(){return e.$apply(function(){return t.$setValidity("server",!0)})})}}}),angular.module("sarDatabase").directive("statusGlyph",function(){return{restrict:"E",template:"<i ng-class=\"{'text-success': test, 'fa-check': test, 'fa-exclamation': !test, 'text-danger': !test}\" class=\"fa\"></i>",scope:{test:"="}}}),angular.module("sarDatabase").service("AccountService",["$http","$q",function(e,r){self=this,$.extend(this,{accounts:{},groups:{},initAccount:function(e){var r;return e.name&&(r=new DatabaseAccountModel(e),self.accounts[e.name]=r),r},loadGroups:function(o){var t=self.accounts[o],s=r.defer();return t.groups.loaded?(s.resolve(t.groups),s):(t.groups.length=0,t.groups.loading=!0,void e({method:"GET",url:window.appRoot+"api/account/rolesforuser/"+o}).success(function(e){$.each(e,function(e,r){self.groups[r]||(self.groups[r]={name:r,groups:[],canEdit:self.rolesIManage.indexOf(r)>=0},self.groups[r].groups.loaded=!1,t.groups.push($.extend({collapsed:!0,remove:!1},self.groups[r])))}),delete t.groups.loading,t.groups.loaded=!0,s.resolve(e)}).error(function(e){s.reject(e)}))},loadMoreGroups:function(o){var t=self.groups[o.name],s=r.defer();return t.groups.loaded?(s.resolve(),s.promise):(e({method:"GET",url:window.appRoot+"api/account/rolesforrole/"+o.name}).success(function(e){$.each(e,function(e,r){self.groups[r]||(self.groups[r]={name:r,groups:[]},self.groups[r].groups.loaded=!1),t.groups.push($.extend({collapsed:!0,remove:!1},self.groups[r]))}),t.groups.loaded=!0}),s.promise)},loadLinkedMember:function(o){var t=self.accounts[o],s=r.defer();return t.linkedMember.loaded?(s.resolve(t.linkedMember),s.promise):(t.linkedMember.loading=!0,e({method:"GET",url:window.appRoot+"api/members/byusername/"+o}).success(function(e){1==e.length&&(t.linkedMember.id=e[0].Id,t.linkedMember.name=e[0].Name,t.linkedMember.units=e[0].Units,t.linkedMember.dem=e[0].DEM),delete t.linkedMember.loading,t.linkedMember.loaded=!0,s.resolve(e)}).error(function(e){s.reject(e)}),s.promise)},getMemberAccount:function(o){var t=r.defer();return e({method:"GET",url:window.appRoot+"api/members/accountfor/"+o}).success(function(e){t.resolve(e)}).error(function(e){t.reject(e)}),t.promise},save:function(o){var t=r.defer();return o.linkedMember.loaded&&delete o.linkedMember.loaded,e({method:"PUT",url:window.appRoot+"api/account",data:o}).success(function(e){t.resolve(e)}).error(function(e){t.reject(e)}),t.promise},setPassword:function(o){if("set"==o.type)return self.save($.extend({},o.account,{password:o.password}));var t=r.defer();return e({method:"POST",url:window.appRoot+"api/account/resetpassword/"+o.account.name}).success(function(e){t.resolve()}).error(function(e){t.reject(e)}),t.promise}})}]),angular.module("sarDatabase").service("EventsService",["$http","$q",function(e,r){self=this,$.extend(this,{list:function(o,t,s){var n=r.defer();o.length=0,o.loading=!0,e({method:"GET",url:window.appRoot+"api/"+t+"/list/"+(s||"")}).success(function(e){$.each(e.events,function(e,r){r.date=moment(r.date),o.unshift(r)}),o.people=e.people,o.miles=e.miles,o.hours=e.hours,delete o.loading,o.loaded=!0,n.resolve(e)}).error(function(e){n.reject(e)})},years:function(o,t){var s=r.defer();return e({method:"GET",url:window.appRoot+"api/"+t+"/years"}).success(function(e){o.length=0,o.push.apply(o,e),s.resolve(e)}).error(function(e){s.reject(e)}),s.promise},save:function(o,t){var s=r.defer();return e({method:o.id?"PUT":"POST",url:window.appRoot+"api/"+t,data:o}).success(function(e){e.start=moment(e.start),e.stop&&(e.stop=moment(e.stop)),s.resolve(e)}).error(function(e){s.reject(e)}),s.promise}})}]);