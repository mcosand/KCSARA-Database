function scrollToTop(e){return $("html").scrollTop()?void $("html").animate({scrollTop:0},{duration:200,complete:e}):$("body").scrollTop()?void $("body").animate({scrollTop:0},{duration:200,complete:e}):void e()}function CreateEditorController(e,t,n,o){angular.module("sarDatabase").controller(e,["$uibModalInstance","dialog","model","EventsService",function(e,r,a,i){var l=this;$.extend(l,{dismiss:function(t){e.dismiss(t)},submit:function(){l.createForm.$valid&&(l.isSaving=!0,l.isWorking=!0,l.errors={},t(l,i).then(function(){delete l.isSaving,delete l.isWorking,e.close(l.model)},function(e){angular.forEach(e.errors,function(e,t){void 0!==l.createForm[t]&&l.createForm[t].$setValidity("server",!1),l.errors[t]=e}),delete l.isSaving,delete l.isWorking}))},checkDelete:function(t){confirm("Delete "+t+"?")&&(l.isDeleting=!0,l.isWorking=!0,n(l.model.id,i,l).then(function(){delete l.isDeleting,delete l.isWorking,e.close(l.model)},function(e){alert("Error: "+e),delete l.isDeleting,delete l.isWorking}))},dialog:r,model:a},(o||function(){})(l))}])}angular.module("sarDatabase").service("EventsService",["$http","$q","Upload",function(e,t,n){function o(n,o,r){for(var i=t.defer(),l=0;l<a.length;l++)a[l].list===n&&(console.log("cancelling previous request to "+a[l].url),a[l].cancel.reject("replaced"),a.splice(l,1));var s=t.defer();n.length=0,n.loading=!0;var u={list:n,url:o,cancel:s};return a.push(u),e({method:"GET",url:o,timeout:s.promise}).success(function(e){r?r(e):n.push.apply(n,e),delete n.loading,n.loaded=!0,a.splice(a.indexOf(u),1),i.resolve(e)}).error(function(e){a.splice(a.indexOf(u),1),i.reject(e)}),i.promise}var r={SignedOut:"Signed Out"},a=[];$.extend(this,{list:function(e,t,n){return o(e,window.appRoot+"api/"+t+"/list/"+(n||""),function(t){$.each(t.events,function(t,n){n.date=moment(n.date),e.unshift(n)}),e.people=t.people,e.miles=t.miles,e.hours=t.hours})},years:function(e,t){return o(e,window.appRoot+"api/"+t+"/years")},save:function(n,o){var r=t.defer();return e({method:n.id?"PUT":"POST",url:window.appRoot+"api/"+o,data:n}).success(function(e){e.start=moment(e.start),e.stop&&(e.stop=moment(e.stop)),r.resolve(e)}).error(function(e){r.reject(e)}),r.promise},documents:function(e,t,n){return o(e,window.appRoot+"api/documents/"+n,function(t){$.each(t,function(t,n){n.thumbUrl=window.appRoot+("image"==n.mime.substring(0,5)?"documents/"+n.id+"/thumbnail":"images/mime/"+n.mime.replace("/","_").replace("+","-")+".png"),n.url=window.appRoot+"documents/"+n.id,n.size=Math.round(n.size/1024*10)/10+"KB",e.push(n)})})},logs:function(e,t,n){return o(e,window.appRoot+"api/"+t+"/"+n+"/logs",function(t){$.each(t,function(t,o){o.eventId=n,o.time=moment(o.time);var r=moment(o.time);r.startOf("day"),(0==e.length||e[e.length-1].date.format()!=r.format())&&e.push({date:r,logs:[]}),e[e.length-1].logs.push(o)})})},saveLog:function(n,o){var r=t.defer();return e({method:n.id?"PUT":"POST",url:window.appRoot+"api/"+o+"/"+n.eventId+"/log",data:n}).success(function(e){e.time=moment(e.time),r.resolve(e)}).error(function(e,t){r.reject(403==t?"login":e)}),r.promise},deleteLog:function(n,o,r){var a=t.defer();return e({method:"DELETE",url:window.appRoot+"api/"+r+"/"+n+"/log/"+o}).success(function(e){a.resolve(e)}).error(function(e,t){a.reject(403==t?"login":e)}),a.promise},saveDocument:function(e){var o=t.defer();return n.upload({url:window.appRoot+"api/documents/"+e.eventId,data:e}).then(function(e){console.log("Success "+e.config.data.file.name+"uploaded. Response: "+e.data),o.resolve(e.data)},function(e){console.log("Error status: "+e.status),o.reject(e)},function(e){var t=parseInt(100*e.loaded/e.total);console.log("progress: "+t+"% "+e.config.data.file.name)}),o.promise},deleteDocument:function(n){var o=t.defer();return e({method:"DELETE",url:window.appRoot+"api/documents/"+n}).success(function(e){o.resolve(e)}).error(function(e,t){o.reject(403==t?"login":e)}),o.promise},roster:function(e,t,n){return o(e,window.appRoot+"api/"+t+"/"+n+"/roster",function(t){$.each(t.responders,function(t,n){n.statusText=r[n.status]||n.status,e.push(n)}),e.responderCount=t.responderCount})},participantTimeline:function(e,t,n,r){return o(e,window.appRoot+"api/"+t+"/"+n+"/participant/"+r+"/timeline",function(t){$.each(t,function(t,n){n.time=n.time?moment(n.time):null,e.push(n)})})},stats:function(e,t){return o(e,window.appRoot+"api/"+t+"/stats",function(t){$.extend(e,t),delete e.length})}})}]),angular.module("sarDatabase").service("MembersService",["$http","$q",function(e,t){function n(n,r,a){for(var i=t.defer(),l=0;l<o.length;l++)o[l].list===n&&(console.log("cancelling previous request to "+o[l].url),o[l].cancel.reject("replaced"),o.splice(l,1));var s=t.defer();n.length=0,n.loading=!0;var u={list:n,url:r,cancel:s};return o.push(u),e({method:"GET",url:r,timeout:s.promise}).success(function(e){a?a(e):n.push.apply(n,e),delete n.loading,n.loaded=!0,o.splice(o.indexOf(u),1),i.resolve(e)}).error(function(e){o.splice(o.indexOf(u),1),i.reject(e)}),i.promise}var o=[];$.extend(this,{addresses:function(e,t){return n(e,window.appRoot+"api/members/"+t+"/addresses",null)},contacts:function(e,t){return n(e,window.appRoot+"api/members/"+t+"/contacts",null)},events:function(e,t,o){return n(e,window.appRoot+"api/members/"+t+"/"+o,function(t){e.count=e.hours=e.miles=0,$.each(t,function(t,n){n.date=moment(n.date),e.unshift(n),e.count++,e.hours+=n.hours||0,e.miles+=n.miles||0})})},eventTimeline:function(e,t,o,r){return n(e,window.appRoot+"api/members/"+t+"/"+o+"/"+r+"/timeline",function(t){$.each(t,function(t,n){n.time=n.time?moment(n.time):null,e.push(n)})})}})}]),angular.module("sarDatabase").factory("loginRecover",["$q","$injector",function(e,t){var n={responseError:function(n){if(403==n.status){var o=t.get("$uibModal"),r=t.get("$http"),a=e.defer(),i=o.open({templateUrl:window.appRoot+"partials/login-modal.html",controller:"LoginModalCtrl",controllerAs:"modal",size:"md",keyboard:!1,backdrop:"static"});i.result.then(function(e){a.resolve(e)},function(e){a.reject(e)});var l=a.promise;return n.config.dontRetryAfterLogin||(l=l.then(function(){return r(n.config)})),l}return e.reject(n)}};return n}]),angular.module("sarDatabase").controller("DashboardCtrl",["$scope","EventsService",function(e,t){$.extend(e,{trainingStats:{},missionStats:{}}),t.stats(e.missionStats,"missions"),t.stats(e.trainingStats,"training");var n=L.map("eventMap").fitBounds([[47.16,-122.53],[47.77,-121.22]]);L.kcsarSetupMap(n,{showLayers:!0,defaultBase:"Google Streets"})}]),angular.module("sarDatabase").controller("LoginModalCtrl",["$uibModalInstance","$q","$http",function(e,t,n){var o=this;$.extend(o,{username:"",password:"",dismiss:function(t){e.dismiss(t)},submit:function(){n({method:"POST",url:window.appRoot+"api/account/login",data:{username:o.username,password:o.password}}).success(function(t){e.close(o.model)})}})}]),angular.module("sarDatabase").controller("MainSearchCtrl",["$scope",function(e){$.extend(e,{searchOptions:{url:window.appRoot+"api/search/",searchParam:"q",itemTemplateUrl:"searchResult.html",listClass:"list-group search-results",limit:8,noFixWidth:!1,onSelect:function(e){"Member"==e.type?window.location.href=window.appRoot+"Members/"+e.summary.id:"Mission"==e.type?window.location.href=window.appRoot+"Missions/"+e.summary.id:console.log(e)}}})}]),angular.module("sarDatabase").controller("EventListCtrl",["$scope","$rootScope","$location","$uibModal","EventsService",function(e,t,n,o,r){function a(){var e=(n.path()||"").match(/\d{4}/);return e?1*e[0]:null}console.log("page loads with location: "+(n.path()||"null"));var i=function(t,o){r.list(e.list,o,t),n.path(t)};$.extend(e,{list:[],years:[],year:a(),detailedEvent:null,eventMap:null,eventTypeText:"",eventRoute:"unknown",init:function(t,n){e.eventRoute=t,e.eventTypeText=n,e.year&&i(e.year,e.eventRoute),r.years(e.years,e.eventRoute).then(function(t){!e.year&&t.length>0&&(e.year=t[0],console.log("setting year in years callback: "+(e.year||"null")))})},showInfo:function(t){e.detailedEvent=e.detailedEvent==t?null:t,e.detailedEvent&&e.detailedEvent.baseLocation&&window.setTimeout(function(){e.eventMap=L.map("eventMap",{zoomControl:!1,attributionControl:!1,dragging:!1,touchZoom:!1,scrollWheelZoom:!1,doubleClickZoom:!1,boxZoom:!1}).setView([e.detailedEvent.baseLocation.lat,e.detailedEvent.baseLocation.lng],10),L.kcsarStaticMap(e.eventMap,{showLayers:!1,defaultBase:"OpenStreetMap"})},5)},tabLink:function(t,n){return window.appRoot+e.eventRoute+"/"+n+"#/"+t},mapClick:function(e,t){alert("hi"),t.stopPropagation()},startCreate:function(){var t=n.path().split("/");t.length<1&&t.push(""),t.length<2&&t.push(e.year),t.length<3&&t.push("create"),t[2]="create",n.path(t.join("/"))},showCreateDialog:function(){scrollToTop(function(){var t={start:moment(),startText:function(e){return arguments.length&&e?(t.start=moment(e,["YYYY-MM-DD HH:mm","YYYY-MM-DD HHmm","MM/DD/YYYY HH:mm","MM/DD/YYYY HHmm"]),t.start.toJSON=function(){return t.start.format("YYYY-MM-DDTHH:mm")},t.start):arguments.length?void(t.start=null):t.start.format("YYYY-MM-DD HH:mm")},county:"king"};t.start.toJSON=function(){return t.start.format("YYYY-MM-DDTHH:mm")};var r=o.open({templateUrl:window.appRoot+"partials/events/create.html",controller:"CreateEventCtrl",controllerAs:"modal",size:"lg",resolve:{model:function(){return t},dialog:function(){return{eventType:e.eventTypeText,eventRoute:e.eventRoute}}}});r.result.then(function(t){i(t.start.year(),e.eventRoute),n.path(n.path().toUpperCase().replace("/CREATE",""))},function(e){n.path(n.path().toUpperCase().replace("/CREATE",""))})})},can:{create:!0}}),e.$watch("year",function(t,n){t!=n&&(console.log("updating list from year watcher. Newvalue:"+t),i(t,e.eventRoute))}),t.$on("$locationChangeStart",function(t,o,r){console.log("handle hash change:"+n.path()),e.year=a(),console.log(n.path().toLowerCase().indexOf("/create")),n.path().toLowerCase().indexOf("/create")>-1&&e.showCreateDialog()})}]),angular.module("sarDatabase").controller("CreateEventCtrl",["$uibModalInstance","dialog","model","EventsService",function(e,t,n,o){var r=this;r.dismiss=function(t){e.dismiss(t)},r.submit=function(){r.createForm.$valid&&(r.errors={},o.save(r.model,t.eventRoute).then(function(){e.close(r.model)},function(e){angular.forEach(e.errors,function(e,t){void 0!==r.createForm[t]&&r.createForm[t].$setValidity("server",!1),r.errors[t]=e})}))},r.dialog=t,r.model=n,r.isBasicOpen=!0,r.lastStep=!1}]),angular.module("sarDatabase").controller("EventViewCtrl",["$scope","$location","$uibModal","EventsService",function(e,t,n,o){function r(e){return(e.match(/^#\/?([^\/]+)/)||["#/info","info"])[1]}$.extend(e,{activeTab:r(t.path()),setTab:function(e){t.path(e)}}),e.$watch(function(){return location.hash},function(t){e.activeTab=r(t)})}]),angular.module("sarDatabase").controller("EventRosterCtrl",["$scope","$uibModal","EventsService",function(e,t,n){$.extend(e,{roster:[],current:null,currentDetails:null,eventRoute:"unknown",eventId:"",init:function(t,o){e.eventRoute=t,e.eventId=o,n.roster(e.roster,t,o).then(null,function(e){console.log(e),alert("error")})},setCurrent:function(t){return t&&e.current&&t.id==e.current.id?void(e.current=null):(e.current=$.extend({},t,{timeline:[]}),void n.participantTimeline(e.current.timeline,e.eventRoute,e.eventId,t.id))},startUpdateStatus:function(e){alert("ok")},can:{create:!0}})}]),angular.module("sarDatabase").controller("EventLogCtrl",["$scope","$uibModal","EventsService",function(e,t,n){$.extend(e,{logs:[],eventRoute:"unknown",eventId:"",init:function(t,o){e.eventRoute=t,e.eventId=o,n.logs(e.logs,t,o).then(null,function(e){console.log(e),alert("error")})},dateText:function(e){return e.calendar(null,{sameDay:"[Today] dddd MM/DD/YYYY",nextDay:"[Tomorrow]",nextWeek:"dddd",lastDay:"[Yesterday] dddd MM/DD/YYYY",lastWeek:"[Last] dddd MM/DD/YYYY",sameElse:"MM/DD/YYYY dddd"})},openLog:function(o,r){o.time.toJSON=function(){return o.time.format("YYYY-MM-DDTHH:mm")},o.timeText=function(e){return arguments.length&&e?(o.time=moment(e,["YYYY-MM-DD HH:mm","YYYY-MM-DD HHmm","MM/DD/YYYY HH:mm","MM/DD/YYYY HHmm"]),o.time.toJSON=function(){return o.time.format("YYYY-MM-DDTHH:mm")},o.time):arguments.length?void(o.time=null):o.time.format("YYYY-MM-DD HH:mm")};var a=t.open({templateUrl:window.appRoot+"partials/events/edit-log.html",controller:"CreateLogCtrl",controllerAs:"modal",size:"lg",resolve:{model:function(){return o},dialog:function(){return{eventRoute:e.eventRoute,isCreate:r}}}});a.result.then(function(t){n.logs(e.logs,e.eventRoute,e.eventId)},function(e){})},startCreate:function(){var t={time:moment(),eventId:e.eventId};e.openLog(t,!0)},can:{create:!0}})}]),angular.module("sarDatabase").controller("EventDocsCtrl",["$scope","$uibModal","EventsService",function(e,t,n){$.extend(e,{documents:[],current:null,eventRoute:"unknown",eventId:"",init:function(t,o){e.eventRoute=t,e.eventId=o,n.documents(e.documents,t,o).then(null,function(e){console.log(e),alert("error")})},downloadDoc:function(e){window.open(e,"_blank","")},editDoc:function(t){e.openDoc(t,!1)},setCurrent:function(t){e.current=t==e.current?null:t},startCreate:function(){var t={eventId:e.eventId,type:"unknown"};e.openDoc(t,!0)},openDoc:function(o,r){var a=t.open({templateUrl:window.appRoot+"partials/events/edit-document.html",controller:"CreateDocCtrl",controllerAs:"modal",size:"md",resolve:{model:function(){return o},dialog:function(){return{eventRoute:e.eventRoute,isCreate:r}}}});a.result.then(function(){n.documents(e.documents,e.eventRoute,e.eventId)},function(e){})},can:{create:!0}})}]),CreateEditorController("CreateDocCtrl",function(e,t){return t.saveDocument(e.model,e.dialog.eventRoute)},function(e,t){return t.deleteDocument(e)},function(e){return{download:function(){window.open(e.model.url,"_blank","")}}}),angular.module("sarDatabase").controller("MembersDashboardCtrl",["$scope",function(e){$.extend(e,{searchOptions:{url:window.appRoot+"api/search/",searchParam:"q",itemTemplateUrl:"searchResult.html",listClass:"list-group search-results",limit:8,params:{t:"Member"},onSelect:function(e){window.location.href=window.appRoot+"Members/"+e.summary.id}}})}]),angular.module("sarDatabase").controller("MembersDetailCtrl",["$scope","$location",function(e,t){function n(e){return(e.match(/^#\/?([^\/]+)/)||["#/info","info"])[1]}$.extend(e,{activeTab:n(t.path()),init:function(t){e.memberId=t},setTab:function(e){t.path(e)}}),e.$watch(function(){return location.hash},function(t){e.activeTab=n(t)})}]),angular.module("sarDatabase").controller("MemberContactsCtrl",["$scope","$uibModal","MembersService",function(e,t,n){$.extend(e,{contacts:[],addresses:[],memberId:"",init:function(t){e.memberId=t,n.contacts(e.contacts,t).then(null,function(e){console.log(e),alert("error")}),n.addresses(e.addresses,t).then(null,function(e){console.log(e),alert("error")})},startAddContact:function(){alert("add contact")},startAddAddress:function(){alert("add address")}})}]),angular.module("sarDatabase").controller("MemberEventsCtrl",["$scope","$uibModal","MembersService",function(e,t,n){$.extend(e,{events:[],memberId:"",eventType:"",showUnitColumn:!0,eventTypeText:"Event",init:function(t,o,r,a){e.showUnitColumn=r,e.memberId=t,e.eventType=o,e.eventTypeText=a,n.events(e.events,t,o).then(null,function(e){console.log(e),alert("error")})},showInfo:function(t){e.detailedEvent=e.detailedEvent==t?null:t,e.detailedEvent&&!e.detailedEvent.timeline&&(e.detailedEvent.timeline=[],n.eventTimeline(e.detailedEvent.timeline,e.memberId,e.eventType,t.id))},tabLink:function(t,n){return window.appRoot+e.eventRoute+"/"+n+"#/"+t}})}]);