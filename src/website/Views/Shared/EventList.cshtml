@{
  ViewBag.Title = (string)ViewBag.EventTypeText + " List";
  ViewBag.NgController = "EventListCtrl";
  bool canEdit = true;
}
@section header {
  <h1>@ViewBag.EventTypeText List</h1>
}
@if (canEdit)
{
  <div ng-cloak ng-if="can.create" ng-click="startCreate()" class="shadow-3" style="position:fixed; bottom:1.5em; right: 1.5em; cursor:pointer; border-radius:50%; background-color: #f39c12; z-index:1000"><i class="fa fa-2x fa-plus" style="color:white; padding:.4em .4em .3em .4em"></i></div>
}
<div class="row">
  <div class="col-xs-12">
    <div class="box box-primary">
      <div class="box-header with-border">
        <div class="pull-right">
          <div>
            <div>
              <strong>Year: </strong>
              <select class="form-control" style="display:inline; width:initial" ng-model="year" ng-options="item as item for item in years"><option value="">All</option></select>
            </div>
          </div>
        </div>
      </div>
      <div class="box-body no-padding">
        <table class="table table-striped table-hover table-condensed">
          <thead>
            <tr>
              <th class="hidden-xs">DEM</th>
              <th>Date</th>
              <th>Name</th>
              <th class="text-right hidden-xs">Persons</th>
              <th class="text-right hidden-xs hidden-sm">Hours</th>
              <th class="text-right hidden-xs hidden-sm">Miles</th>
            </tr>
          </thead>
          <tbody ng-cloak>
            <tr ng-repeat="e in list" ng-click="showInfo(e)" ng-cloak>
              <td ng-if="detailedEvent != e" class="hidden-xs">{{e.number}}</td>
              <td ng-if="detailedEvent != e">{{e.date.toDate() | date:'M/d/yyyy'}}</td>
              <td ng-if="detailedEvent != e" style="position:relative">
                {{e.title}}
                <div class="parent-hover-show" style="position:absolute; right:5px; top:5px;">
                  <a ng-href="{{tabLink('documents', e.id)}}" ng-click="$event.stopPropagation()" title="View Documents"><i class="fa fa-fw fa-file-text-o"></i></a>
                  <a ng-href="{{tabLink('roster', e.id)}}" ng-click="$event.stopPropagation()" title="View Roster"><i class="fa fa-fw fa-list-alt"></i></a>
                </div>
              </td>
              <td ng-if="detailedEvent != e" class="text-right hidden-xs">{{e.people}}</td>
              <td ng-if="detailedEvent != e" class="text-right hidden-xs hidden-sm">{{e.hours | number:2}}</td>
              <td ng-if="detailedEvent != e" class="text-right hidden-xs hidden-sm">{{e.miles}}</td>
              <td ng-if="detailedEvent == e" class="active shadow-2" colspan="7" style="border-top:solid 1px #bbb; border-bottom: solid 1px #bbb">
                <div class="row">
                  <div class="col-xs-12 col-sm-6">
                    <h4 style="margin: 0px; font-weight:bold">{{e.title}}</h4>
                    <div><strong>DEM#:</strong> {{e.number}}</div>
                    <div><strong>Started:</strong> {{e.date.toDate() | date: 'EEE M/d/yyyy h:mm a'}}</div>
                    <div style="margin:.4em 0px .7em;"><strong>Persons:</strong> {{e.people}} <strong>Hours:</strong> {{e.hours | number: 2}} <strong>Miles:</strong> {{e.miles}}</div>
                  </div>
                  <div class="col-xs-6 col-sm-3">
                    <div><a ng-href="{{tabLink('roster', e.id)}}" ng-click="$event.stopPropagation()"><i class="fa fa-fw fa-list-alt"></i> Roster</a></div>
                    <div><a ng-href="{{tabLink('log', e.id)}}" ng-click="$event.stopPropagation()"><i class="fa fa-fw fa-pencil-square-o"></i> Log</a></div>
                    <div><a ng-href="{{tabLink('documents', e.id)}}" ng-click="$event.stopPropagation()"><i class="fa fa-fw fa-file-text-o"></i> Documents</a></div>
                  </div>
                  <div class="col-xs-6 col-sm-3">
                    <div id="eventMap" ng-if="detailedEvent.baseLocation" class="static-map" style="height:7em; width:100%; border:solid 1px black" ng-click="mapClick(e.id, $event);"></div>
                    <div ng-if="!detailedEvent.baseLocation" style="margin: auto; width:100%; text-align:center; height:7em">Unknown Base Location</div>
                  </div>
                </div>
              </td>
            </tr>
          </tbody>
          <tfoot>
            <tr>
              <th class="hidden-xs"></th>
              <th></th>
              <th>{{list.length}} Missions</th>
              <th class="text-right hidden-xs">{{list.people}}</th>
              <th class="text-right hidden-xs hidden-sm">{{list.hours | number:2}}</th>
              <th class="text-right hidden-xs hidden-sm">{{list.miles}}</th>
            </tr>
          </tfoot>
        </table>
      </div>
      <div ng-if="list.loading" class="overlay">
        <i class="fa fa-refresh fa-spin"></i>
      </div>
    </div>
  </div>
</div>
@section head {<link rel="stylesheet" type="text/css" href="~/lib/mapbox.js/mapbox.css" />
  <link rel="stylesheet" type="text/css" href="~/css/sar-map.min.css" />}
@section scripts {
  @if (canEdit)
  {
    <script type="text/ng-template" id="create.html">
    </script>
  }
  <script src="//maps.google.com/maps/api/js?v=3.2&sensor=false"></script>
  <script type="text/javascript" src="~/lib/mapbox.js/mapbox.uncompressed.js"></script>
  <script type="text/javascript" src="~/lib/leaflet.google.js"></script>
  <script type="text/javascript" src="~/lib/TileLayer.GeoJSON.js"></script>
  <script type="text/javascript" src="~/js/maps/map.js"></script>
  @if (canEdit)
  {
    <script type="text/javascript">
      function scrollToTop(callback) {
        if ($('html').scrollTop()) {
          $('html').animate({ scrollTop: 0 }, {duration: 200, complete: callback});
          return;
        }

        if ($('body').scrollTop()) {
          $('body').animate({ scrollTop: 0 }, {duration: 200, complete: callback});
          return;
        }

        callback();
      }

      angular.module('sarDatabase').controller('CreateEventCtrl', ['$uibModalInstance', 'dialog', 'model', 'EventsService', function($uibModalInstance, dialog, model, EventsService) {
        var modal = this;
        modal.dismiss = function(reason) {
          $uibModalInstance.dismiss(reason);
        }
        modal.submit = function () {
          if (!modal.createForm.$valid) return;

          modal.errors = {}; //clean up previous server errors

          EventsService.save(modal.model, dialog.eventRoute)
          .then(function () {
            $uibModalInstance.close(modal.model);
          }, function (response) {
            angular.forEach(response.errors, function (errors, field) {
              if (modal.createForm[field] !== undefined) { modal.createForm[field].$setValidity('server', false); }
              modal.errors[field] = errors;
            });
          });
        }
        modal.dialog = dialog;
        modal.model = model;
        modal.isBasicOpen = true;
        modal.lastStep = false;
      }]);
    </script>
  }
  <script type="text/javascript">
    angular.module('sarDatabase').controller('EventListCtrl', ['$scope', '$rootScope', '$location', '$uibModal', 'EventsService',
      function ($scope, $rootScope, $location, $uibModal, EventsService) {
        var loadList = function (year) {
          console.log('changing year' + year)
          EventsService.list($scope.list, '@ViewBag.EventRoute', year);
          $location.path(year);
        }
      $.extend($scope, {
        list: [],
        years: [],
        year: new Date().getFullYear(),
        detailedEvent: null,
        eventMap: null,
        showInfo: function(e) {
          $scope.detailedEvent = ($scope.detailedEvent == e) ? null : e;
          if ($scope.detailedEvent && $scope.detailedEvent.baseLocation) {
            window.setTimeout(function() {
              $scope.eventMap = L.map('eventMap', {zoomControl:false, attributionControl:false, dragging: false, touchZoom: false, scrollWheelZoom: false, doubleClickZoom: false, boxZoom: false})
                .setView([$scope.detailedEvent.baseLocation.lat, $scope.detailedEvent.baseLocation.lng], 10);
              L.kcsarStaticMap($scope.eventMap, {showLayers: false, defaultBase: 'OpenStreetMap'});
            }, 5);
          }
        },
        tabLink: function(action, id) {
          return window.appRoot + '@ViewBag.EventRoute/' + id + '#/' + action;
        },
        mapClick: function(id, $event) {
          alert('hi');
          $event.stopPropagation();
        },
        startCreate: function () {
          var parts = $location.path().split('/');
          if (parts.length < 1) { parts.push(''); }
          if (parts.length < 2) { parts.push($scope.year); }
          if (parts.length < 3) { parts.push('create'); }
          parts[2] = "create";
          $location.path(parts.join('/'));
        },
        showCreateDialog: function() {
          scrollToTop(function() {
            var model = {
              start: moment(),
              startText: function (val) {
                if (arguments.length && val) {
                  model.start = moment(val, ["YYYY-MM-DD HH:mm", "YYYY-MM-DD HHmm", "MM/DD/YYYY HH:mm", "MM/DD/YYYY HHmm"]);
                  model.start.toJSON = function () { return model.start.format("YYYY-MM-DDTHH:mm") };
                  return model.start;
                } else if (arguments.length) {
                  model.start = null;
                } else {
                  return model.start.format('YYYY-MM-DD HH:mm');
                }
              },
              county: 'king'
            };
            model.start.toJSON = function () { return model.start.format("YYYY-MM-DDTHH:mm") };

            var modalInstance = $uibModal.open({
              templateUrl: window.appRoot + 'partials/events/create.html',
              controller: 'CreateEventCtrl',
              controllerAs: 'modal',
              size: 'lg',
              resolve: {
                model: function() { return model },
                dialog: function() { return {
                  eventType: '@ViewBag.EventTypeText',
                  eventRoute: '@ViewBag.EventRoute'
                }}
              }
            });
            modalInstance.result
            .then(function (data) {
              loadList(data.start.year());
              $location.path($location.path().toUpperCase().replace('/CREATE', ''));
            }, function (reason) {
              $location.path($location.path().toUpperCase().replace('/CREATE', ''));
              //  alert('dismissed');
            });
          });
        },
        can: {
          create: true//@(User.IsInRole("cdb." + ViewBag.EventTypeText.ToLower() + "editors").ToString().ToLower())
        }
      });
      $scope.$watch("year", function(newValue, oldValue) {
        if (newValue == oldValue) return;
        loadList(newValue);
       });
      $rootScope.$on('$locationChangeStart', function(event, newUrl, oldUrl) {
        console.log(newUrl);
        var parts = $location.path().split('/');
        if (parts.length < 2) return; // The route will get '/' prepended and we'll come back around
        var hashYear = parts[1];
        hashYear = parseInt(hashYear);
        if (!isNaN(hashYear)) { $scope.year = hashYear; if ($scope.years.length == 0) { $scope.years = [hashYear]; }}
        if ((parts[parts.length-1] || '').toLowerCase() == "create") {
          $scope.showCreateDialog();
        }
      });
      EventsService.list($scope.list, '@ViewBag.EventRoute', $scope.year);
      EventsService.years($scope.years, '@ViewBag.EventRoute').then(function(list) {
        $scope.year = list.length > 0 ? list[0] : null;
      });
    }]);
  </script>
}